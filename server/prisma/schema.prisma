generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Position {
  id         Int         @id @default(autoincrement())
  name       String
  seats      Int         @default(1)
  opens_at   DateTime
  closes_at  DateTime
  candidates Candidate[]
  votes      Vote[]

  @@map("positions")
}

model Candidate {
  id            Int      @id @default(autoincrement())
  position_id   Int
  name          String
  manifesto_url String?  @db.Text
  photo_url     String?  @db.Text
  status        String   @default("SUBMITTED") // SUBMITTED, APPROVED, REJECTED
  reason        String?  @db.Text
  created_at    DateTime @default(now())
  
  position      Position @relation(fields: [position_id], references: [id])
  votes         Vote[]

  @@map("candidates")
}

model EligibleVoter {
  id            Int            @id @default(autoincrement())
  reg_no        String         @unique
  name          String
  email         String?
  phone         String?
  program       String?
  status        String         @default("ELIGIBLE") // ELIGIBLE, BLOCKED
  verifications Verification[]
  ballots       Ballot[]

  @@map("eligible_voters")
}

model Verification {
  id           Int           @id @default(autoincrement())
  voter_id     Int
  method       String?       // EMAIL, SMS
  otp_hash     String
  issued_at    DateTime      @default(now())
  verified_at  DateTime?
  ballot_token String?       @unique
  consumed_at  DateTime?
  
  voter        EligibleVoter @relation(fields: [voter_id], references: [id])

  @@map("verifications")
}

model Ballot {
  id          Int           @id @default(autoincrement())
  voter_id    Int
  election_id Int?
  issued_at   DateTime      @default(now())
  consumed_at DateTime?
  
  voter       EligibleVoter @relation(fields: [voter_id], references: [id])
  votes       Vote[]

  @@map("ballots")
}

model Vote {
  id           Int       @id @default(autoincrement())
  ballot_id    Int
  position_id  Int
  candidate_id Int
  cast_at      DateTime  @default(now())
  
  ballot       Ballot    @relation(fields: [ballot_id], references: [id])
  position     Position  @relation(fields: [position_id], references: [id])
  candidate    Candidate @relation(fields: [candidate_id], references: [id])

  @@map("votes")
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actor_type  String?
  actor_id    String?
  action      String?
  entity      String?
  entity_id   String?
  payload     Json?
  created_at  DateTime @default(now())

  @@map("audit_logs")
}
